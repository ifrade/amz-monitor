#!/usr/bin/sh
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

VERBOSE=1
while getopts ":s" opt; do
  case $opt in
      s)
          VERBOSE=0
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      ;;
  esac
  shift
done

ASINS=
if [ $# -gt 0 ]; then
    for asin in "$@" ; do
        if [ -e .amz/idx/$asin ]; then
            ASINS="$ASINS $asin";
        else
            echo "Skipping $asin (.amz/idx/$asin doesn't exist)"
        fi
    done
else
    ASINS=$(ls .amz/idx)
fi

for SIMPLE_ASIN in $ASINS ; do
    
    echo "Fetching $SIMPLE_ASIN ("$(cat .amz/idx/$SIMPLE_ASIN)")"
    ./lib/amzPage2json.js $SIMPLE_ASIN > x.json
    [ $? -ne 0 ] && echo "Something wrong processing the amazon page. Skipping." && continue

    #cat x.html | ./lib/json2tab.js > x.tmp
    md5=`md5sum x.json | awk '{ print $1 }'`

    if [ ! -e .amz/refs/$SIMPLE_ASIN ]; then
        previous_md5=$(cat .amz/refs/null)
    else
        previous_md5=$(cat .amz/refs/$SIMPLE_ASIN)
    fi

    if [ $md5 != $previous_md5 ]; then
        # Save previous best price
        $DIR/amz-best -s $SIMPLE_ASIN > .tmp-fetch-best

        # Create object, set parent to current HEAD
        cat x.json | jq --arg parent $previous_md5 --arg date "$(date)" \
                        '{ entries: . , parent: $parent, date: $date }' \
                        > .amz/objects/$md5

        # Update HEAD reference
        echo $md5 > .amz/refs/$SIMPLE_ASIN

        # add latest best price to previously saved best price
        NEW_BEST_PRICE=$(cat .amz/objects/$md5  | jq -r '.entries[0]' | node ./lib/jsonFormPrice.js)
        NEW_DATE=$(cat .amz/objects/$md5  | jq -r '.date')
        echo "$NEW_BEST_PRICE $NEW_DATE" >> .tmp-fetch-best

        # sort and take head to know the best and resave
        UPDATED_BEST_PRICE=$(sort -k1n -k7nr -k3Mr -k4nr .tmp-fetch-best | head -1 | tee .amz/best-price/$SIMPLE_ASIN)

        [[ $VERBOSE -eq 1 ]] && echo "Best price seen: $UPDATED_BEST_PRICE"
        [[ $VERBOSE -eq 1 ]] && $DIR/amz-diff $SIMPLE_ASIN

        rm -f .tmp-fetch-best
    fi

    rm -f x.html x.tmp
done
